{% extends 'base.html' %}

{% block title %}فرم تکمیلی - مرکز تشخیص و درمان اختلالات خواب{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/form8.css' %}">
{% endblock %}

{% block content %}
<div class="form-header">
    <h2 class="form-title">فرم تکمیلی</h2>
    <span class="form-date persian-date"></span>
</div>

<form method="post" action="{% url 'form8' %}">
    {% csrf_token %}
    
    <!-- Patient Info Row -->
    <div class="form-row">
        <div class="form-col">
            <label for="patient_name">نام بیمار:</label>
            <input type="text" id="patient_name" name="patient_name" required>
        </div>
        <div class="form-col">
            <label for="form_date">تاریخ:</label>
            <input type="date" id="form_date" name="form_date" required>
        </div>
    </div>

<div class="admit-section" dir="rtl">
  <h3 style="color:#2e7d32;margin:0 0 12px;"> لطفا اطلاعات مربوط به بستری بیمارستانی خود را در صورت وجود با ذکر دلیل و تاریخ قید نمایید ( تا جایی که به خاطر دارید )</h3>

  <table class="admit-table" id="admitTable">
    <thead>
      <tr>
        <th class="th-reason">علت بستری</th>
        <th class="th-date">تاریخ</th>
        <th class="th-actions">عملیات</th>
      </tr>
    </thead>
    <tbody id="admitBody">
      <!-- ردیف‌های پویا اینجا می‌آیند -->
    </tbody>
  </table>

  <button type="button" id="addRowBtn" class="btn-primary">افزودن سطر</button>
</div>

<!-- الگوی ردیف -->
<template id="admitRowTpl">
  <tr>
    <td><input type="text" name="admit_reason_0" placeholder="مثلاً: جراحی، عفونت، ..."></td>
    <td><input type="date" name="admit_date_0"></td>
    <td class="actions">
      <button type="button" class="btn-danger remove-row">حذف</button>
    </td>
  </tr>
</template>

<script>
  (function(){
    const body   = document.getElementById('admitBody');
    const btnAdd = document.getElementById('addRowBtn');
    const tpl    = document.getElementById('admitRowTpl');

    // مقدار اولیه: یک ردیف خالی
    addRow();

btnAdd.addEventListener('click', () => addRow());

    // حذف با delegation
    body.addEventListener('click', (e)=>{
      if(e.target.classList.contains('remove-row')){
        const row = e.target.closest('tr');
        row?.remove();
        reindex();
        // اگر همه حذف شدند، یکی اضافه کن که خالی نماند
        if(!body.querySelector('tr')) addRow();
      }
    });

    function addRow(reason='', date=''){
      const clone = tpl.content.firstElementChild.cloneNode(true);
      const [reasonInput, dateInput] = clone.querySelectorAll('input');
      reasonInput.value = reason;
      dateInput.value = date;
      body.appendChild(clone);
      reindex();
    }

    // به‌روزرسانی نام‌ها برای ارسال تمیز به سرور
    function reindex(){
      [...body.querySelectorAll('tr')].forEach((tr, idx)=>{
        const inputs = tr.querySelectorAll('input');
        const reason = inputs[0];
        const date   = inputs[1];
        reason.name = `admit[${idx}][reason]`;
        date.name   = `admit[${idx}][date]`;
      });
    }

    // در صورت نیاز از بیرون هم می‌تونی اضافه کنی:
    // window.addAdmitRow = (r='', d='') => addRow(r, d);
  })();
</script>

    <!-- Medication and Treatment -->
    <div class="scale-container" style="margin-top: 30px;">
        <h3 style="color: var(--primary-green); margin-bottom: 20px;">لطفا جزئیات مهم در ارتباط با وضعیت سلامتی و درمانی خود را ذکر فرمایید:</h3>
        <textarea class="large-textarea" name="health_treatment_details" 
              ></textarea>
    </div>

    <!-- Study Information -->
    <div class="scale-container">
        <p style="margin-bottom: 5px;">
در اینجا لازم است بدانیم در شش ماه اخیر چه داروها، ویتامین ها و یا داروهای گیاهی را مصرف نموده اید. لطفا کمد داروئی و یا دفترچه بیمه خود را برای اینکه به خوبی بتوانید داروهای مصرفی را به یاد آورید بررسی نمایید. به مشکلات  و بیماری هایی که اخیرا داشته داشته و برای درمان آن داروهایی  را که مصرف نموده اید  فکر کنید.
        </p>
        

    </div>

    <!-- Additional Treatment Grid -->
    <div class="scale-container" style="margin-top: 30px;">
        
        <!-- Empty grid for additional treatment information -->
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
            <!-- Row headers -->
            <div style="grid-column: span 6;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>نام دارو، ویتامین و یا داروی گیاهی که استفاده کرده اید</th>
                            <th>برای چه مدتی</th>
                            <th>مقدار مصرف</th>
                            <th>چند قرص</th>
                            <th>برای چه بیماری</th>
                            <th>هنوز استفاده می کنید؟ بله / خیر</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" name="med_1_name" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_1_quality" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_1_dosage" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_1_quantity" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_1_condition" style="border: none; width: 100%;"></td>
                            <td>
                                <select name="med_1_self" style="border: none; width: 100%;">
                                    <option value="">---</option>
                                    <option value="yes">بله</option>
                                    <option value="no">خیر</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="med_2_name" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_2_quality" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_2_dosage" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_2_quantity" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_2_condition" style="border: none; width: 100%;"></td>
                            <td>
                                <select name="med_2_self" style="border: none; width: 100%;">
                                    <option value="">---</option>
                                    <option value="yes">بله</option>
                                    <option value="no">خیر</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="med_3_name" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_3_quality" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_3_dosage" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_3_quantity" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_3_condition" style="border: none; width: 100%;"></td>
                            <td>
                                <select name="med_3_self" style="border: none; width: 100%;">
                                    <option value="">---</option>
                                    <option value="yes">بله</option>
                                    <option value="no">خیر</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="med_4_name" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_4_quality" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_4_dosage" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_4_quantity" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_4_condition" style="border: none; width: 100%;"></td>
                            <td>
                                <select name="med_4_self" style="border: none; width: 100%;">
                                    <option value="">---</option>
                                    <option value="yes">بله</option>
                                    <option value="no">خیر</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="text" name="med_5_name" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_5_quality" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_5_dosage" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_5_quantity" style="border: none; width: 100%;"></td>
                            <td><input type="text" name="med_5_condition" style="border: none; width: 100%;"></td>
                            <td>
                                <select name="med_5_self" style="border: none; width: 100%;">
                                    <option value="">---</option>
                                    <option value="yes">بله</option>
                                    <option value="no">خیر</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>



    <!-- Form Actions -->
    <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='{% url 'form7' %}'">قبلی</button>
        <button type="submit" class="btn btn-primary">ذخیره و ارسال نهایی</button>
    </div>
</form>
{% endblock %}